# **F2.1 - Gestion des Cultures & Vari√©t√©s**

## **üìã Informations g√©n√©rales**
- **Score de priorit√©** : 90/100 ‚≠ê PRIORIT√â √âLEV√âE
- **EPIC** : PILIER PRODUIRE - CORE FEATURES
- **Complexit√©** : Moyenne (CRUD + recherche)
- **Devices** : üì±üíªüì∫

## **üéØ Description**
Base de connaissances compl√®te des cultures avec fiches techniques personnalisables, catalogue pr√©-rempli de 100+ vari√©t√©s courantes, syst√®me de recherche et filtrage avanc√©s, et personnalisation utilisateur avec tracking de performance sp√©cifique au terrain.

## **üë• User Stories**

### **Catalogage et personnalisation**
- En tant que jardinier, je veux cataloguer toutes mes vari√©t√©s avec leurs sp√©cificit√©s et performances sur mon terrain
- En tant qu'utilisateur, je veux des fiches techniques adapt√©es √† mon climat et type de sol
- En tant qu'expert, je veux pouvoir cr√©er des vari√©t√©s personnalis√©es et modifier les donn√©es existantes

### **Recherche et d√©couverte**
- En tant qu'utilisateur, je veux rechercher des vari√©t√©s selon mes crit√®res (famille, difficult√©, saison)
- En tant que d√©butant, je veux des recommandations de vari√©t√©s faciles pour commencer
- En tant qu'utilisateur, je veux d√©couvrir de nouvelles vari√©t√©s compatibles avec mon jardin

### **Performance et historique**
- En tant que jardinier, je veux tracker les performances de chaque vari√©t√© sur mon terrain
- En tant qu'utilisateur, je veux comparer mes r√©sultats d'une ann√©e sur l'autre
- En tant que syst√®me IA, je veux des donn√©es structur√©es pour optimiser les recommandations

## **üå± Architecture de donn√©es**

### **Mod√®le VarieteCulture (Base de connaissances)**
```prisma
model VarieteCulture {
  id              String @id @default(cuid())
  nomScientifique String?
  nomCommun       String @db.VarChar(200)
  famille         String? @db.VarChar(100) // Solanaceae, Brassicaceae
  categorie       CategorieCulture
  
  // Caract√©ristiques de culture (JSON structur√©)
  infosCulture    Json @db.JsonB // Structure d√©taill√©e ci-dessous
  
  // Calendrier par d√©faut (adaptable par r√©gion)
  calendrierDefaut Json @db.JsonB // {moisSemis[], moisPlantation[], moisRecolte[]}
  
  // Donn√©es enrichies par l'IA et feedback utilisateurs
  insightsIA      Json? @db.JsonB // {tauxReussite, conditionsOptimales, problemesCourants}
  
  // M√©tadonn√©es source
  sourceDonnees   SourceDonnees @default(MANUEL)
  estPersonnalise Boolean @default(false)
  creeParId       String?
  
  // Images et documentation
  photos          Json? @db.JsonB // [{url, legende, type}]
  liens           Json? @db.JsonB // [{url, titre, type}]
  
  creeA       DateTime @default(now()) @db.Timestamptz
  misAJourA   DateTime @updatedAt @db.Timestamptz
  
  // Relations
  creePar                     User? @relation(fields: [creeParId], references: [id])
  varietesUtilisateur         VarieteCultureUtilisateur[]
  
  // Index pour recherche performante
  @@index([famille, categorie])
  @@index([nomCommun]) // Recherche textuelle
  @@fulltext([nomCommun, nomScientifique]) // PostgreSQL full-text search
  @@map("varietes_culture")
}

// Structure JSON pour infosCulture
interface InfosCulture {
  // Plantation
  profondeurPlantationCm: number;
  espacementCm: number;
  expositionSoleil: 'PLEIN_SOLEIL' | 'MI_OMBRE' | 'OMBRE';
  
  // Timing
  joursGermination: number;
  joursRecolte: number;
  dureeRecolte?: number; // semaines
  
  // Conditions
  temperatureMinSemis: number;
  temperatureOptimaleCroissance: [number, number]; // [min, max]
  besoinsEau: 'FAIBLE' | 'MOYEN' | 'ELEVE';
  typesolPrefere: string[];
  phOptimal: [number, number];
  
  // Associations
  plantesCompagnes: string[];
  plantesIncompatibles: string[];
  
  // Difficult√©s et conseils
  niveauDifficulte: 1 | 2 | 3 | 4 | 5;
  conseilsCulture: string[];
  problemesCourants: string[];
  
  // Production
  rendementMoyenKgM2?: number;
  hauteurMoyenneCm?: number;
  resistanceFroid?: boolean;
  resistanceMaladies?: string[];
}

enum CategorieCulture {
  LEGUME
  FRUIT
  HERBE_AROMATIQUE
  FLEUR
  ARBRE
  VIGNE
}

enum SourceDonnees {
  MANUEL
  API
  GENERE_IA
  SCAN_EMBALLAGE // F2.6 - Scan de graines
  IMPORT_EXTERNE
}
```

### **Mod√®le VarieteCultureUtilisateur (Personnalisation)**
```prisma
model VarieteCultureUtilisateur {
  id                      String @id @default(cuid())
  utilisateurId           String
  varieteBaseId           String
  
  // Personnalisation utilisateur
  nomPersonnalise         String? @db.VarChar(200) // "Tomates cerises du garage"
  notesPersonnelles       String? @db.Text
  infosCulturePersonnalisees Json? @db.JsonB // Override des infos de base
  
  // Performance tracking personnalis√©
  performancePersonnelle  Json @db.JsonB // Structure d√©taill√©e ci-dessous
  
  // Photos personnalis√©es
  photos                  Json? @db.JsonB // [{url, legende, priseA, stade}]
  
  // √âtat et pr√©f√©rences
  estFavorite            Boolean @default(false)
  estRecommandee         Boolean @default(false) // Recommand√© par IA
  dateTest               DateTime? // Premi√®re fois test√©e
  
  // √âvaluation utilisateur
  noteGlobale            Int? @db.SmallInt // 1-5
  commentaireExperience  String? @db.Text
  
  creeA                  DateTime @default(now()) @db.Timestamptz
  misAJourA              DateTime @updatedAt @db.Timestamptz
  
  // Relations
  utilisateur    User @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)
  varieteBase    VarieteCulture @relation(fields: [varieteBaseId], references: [id])
  instancesCulture InstanceCulture[]
  
  // Contrainte unicit√© par utilisateur
  @@unique([utilisateurId, varieteBaseId])
  @@index([utilisateurId, estFavorite])
  @@map("varietes_culture_utilisateur")
}

// Structure JSON pour performancePersonnelle
interface PerformancePersonnelle {
  // Statistiques agr√©g√©es
  nombreCultivations: number;
  tauxReussite: number; // 0-1
  rendementMoyenKg: number;
  rendementMoyenKgM2: number;
  
  // Meilleures performances
  meilleureRecolte: {
    annee: number;
    poids: number;
    notesQualite: number;
  };
  
  // Dates optimales d√©couvertes
  meilleureDateSemis?: string; // MM-DD format
  meilleureDateRecolte?: string;
  
  // Conditions optimales sur ce terrain
  conditionsOptimales: {
    zone: string;
    exposition: string;
    amendements: string[];
  };
  
  // Historique par ann√©e
  historique: Array<{
    annee: number;
    zoneCultivee: string;
    poidsTotalKg: number;
    qualiteMoyenne: number;
    problemes: string[];
    succes: string[];
  }>;
  
  // M√©tadonn√©es
  derniereMiseAJour: string;
  calculPar: 'MANUEL' | 'AUTO';
}
```

## **üîç Service de gestion des vari√©t√©s**

### **Recherche intelligente et recommandations**
```typescript
export class VarietyManagementService {
  private prisma: PrismaClient;
  private cache: RedisCache;
  private aiService: AIRecommendationService;

  constructor() {
    this.prisma = new PrismaClient();
    this.cache = new RedisCache();
    this.aiService = new AIRecommendationService();
  }

  async searchVarieties(params: VarietySearchParams): Promise<VarietySearchResult> {
    const cacheKey = `variety_search:${JSON.stringify(params)}`;
    
    // Check cache first
    const cached = await this.cache.get(cacheKey);
    if (cached) return cached;

    // Build dynamic search query
    const searchQuery = this.buildSearchQuery(params);
    
    const varieties = await this.prisma.varieteCulture.findMany({
      where: searchQuery,
      include: {
        varietesUtilisateur: {
          where: { utilisateurId: params.userId },
          select: {
            estFavorite: true,
            noteGlobale: true,
            performancePersonnelle: true
          }
        },
        _count: {
          select: {
            varietesUtilisateur: true // Popularit√©
          }
        }
      },
      orderBy: this.buildOrderBy(params.sortBy),
      take: params.limit || 50
    });

    // Enrich with AI recommendations if requested
    const enrichedResults = params.includeAI 
      ? await this.enrichWithAIRecommendations(varieties, params)
      : varieties;

    const result: VarietySearchResult = {
      varieties: enrichedResults,
      totalCount: varieties.length,
      filters: await this.getAvailableFilters(),
      recommendations: params.includeRecommendations 
        ? await this.getPersonalizedRecommendations(params.userId)
        : undefined
    };

    // Cache for 1 hour
    await this.cache.set(cacheKey, result, 3600);
    
    return result;
  }

  private buildSearchQuery(params: VarietySearchParams): Prisma.VarieteCultureWhereInput {
    const where: Prisma.VarieteCultureWhereInput = {};

    // Text search
    if (params.query) {
      where.OR = [
        { nomCommun: { contains: params.query, mode: 'insensitive' } },
        { nomScientifique: { contains: params.query, mode: 'insensitive' } },
        { famille: { contains: params.query, mode: 'insensitive' } }
      ];
    }

    // Category filter
    if (params.categories?.length) {
      where.categorie = { in: params.categories };
    }

    // Difficulty filter
    if (params.difficultyMax) {
      where.infosCulture = {
        path: ['niveauDifficulte'],
        lte: params.difficultyMax
      };
    }

    // Season filter (pour semis/plantation)
    if (params.currentMonth) {
      where.calendrierDefaut = {
        path: ['moisSemis'],
        array_contains: params.currentMonth
      };
    }

    // Climate compatibility
    if (params.climate) {
      where.infosCulture = {
        path: ['typesolPrefere'],
        array_contains: params.climate.typeSol
      };
    }

    // Only user favorites
    if (params.favoritesOnly && params.userId) {
      where.varietesUtilisateur = {
        some: {
          utilisateurId: params.userId,
          estFavorite: true
        }
      };
    }

    return where;
  }

  async getPersonalizedRecommendations(userId: string): Promise<PersonalizedRecommendation[]> {
    // Analyser historique utilisateur
    const userHistory = await this.getUserCultivationHistory(userId);
    
    // Obtenir profil jardin (climat, sol, zones)
    const gardenProfile = await this.getGardenProfile(userId);
    
    // G√©n√©rer recommandations IA
    const recommendations = await this.aiService.generateVarietyRecommendations({
      userHistory,
      gardenProfile,
      currentSeason: new Date().getMonth() + 1
    });

    return recommendations.map(rec => ({
      variete: rec.variety,
      scoreRecommandation: rec.score,
      raisons: rec.reasons,
      adaptationTerrain: rec.terrainFit,
      probabiliteSucces: rec.successProbability,
      conseilsSpecifiques: rec.specificTips
    }));
  }

  async createPersonalizedVariety(
    userId: string, 
    baseVarietyId: string, 
    customizations: VarietyCustomization
  ): Promise<VarieteCultureUtilisateur> {
    
    return this.prisma.$transaction(async (tx) => {
      // V√©rifier que la vari√©t√© base existe
      const baseVariety = await tx.varieteCulture.findUnique({
        where: { id: baseVarietyId }
      });

      if (!baseVariety) {
        throw new Error('Base variety not found');
      }

      // Cr√©er ou mettre √† jour la personnalisation
      const personalizedVariety = await tx.varieteCultureUtilisateur.upsert({
        where: {
          utilisateurId_varieteBaseId: {
            utilisateurId: userId,
            varieteBaseId: baseVarietyId
          }
        },
        create: {
          utilisateurId: userId,
          varieteBaseId: baseVarietyId,
          nomPersonnalise: customizations.nomPersonnalise,
          notesPersonnelles: customizations.notesPersonnelles,
          infosCulturePersonnalisees: customizations.infosCulture,
          performancePersonnelle: {
            nombreCultivations: 0,
            tauxReussite: 0,
            rendementMoyenKg: 0,
            rendementMoyenKgM2: 0,
            historique: [],
            derniereMiseAJour: new Date().toISOString(),
            calculPar: 'MANUEL'
          },
          estFavorite: customizations.estFavorite || false
        },
        update: {
          nomPersonnalise: customizations.nomPersonnalise,
          notesPersonnelles: customizations.notesPersonnelles,
          infosCulturePersonnalisees: customizations.infosCulture,
          estFavorite: customizations.estFavorite,
          misAJourA: new Date()
        },
        include: {
          varieteBase: true
        }
      });

      // Invalider le cache des recherches
      await this.cache.deletePattern(`variety_search:*${userId}*`);

      return personalizedVariety;
    });
  }

  async updatePerformanceData(
    userId: string,
    varietyId: string,
    performanceData: PerformanceUpdate
  ): Promise<void> {
    
    const existing = await this.prisma.varieteCultureUtilisateur.findUnique({
      where: {
        utilisateurId_varieteBaseId: {
          utilisateurId: userId,
          varieteBaseId: varietyId
        }
      }
    });

    if (!existing) {
      throw new Error('Personalized variety not found');
    }

    const currentPerf = existing.performancePersonnelle as PerformancePersonnelle;
    
    // Calculer nouvelles m√©triques
    const updatedPerf = this.calculateUpdatedPerformance(currentPerf, performanceData);

    await this.prisma.varieteCultureUtilisateur.update({
      where: {
        utilisateurId_varieteBaseId: {
          utilisateurId: userId,
          varieteBaseId: varietyId
        }
      },
      data: {
        performancePersonnelle: updatedPerf,
        misAJourA: new Date()
      }
    });
  }

  private calculateUpdatedPerformance(
    current: PerformancePersonnelle,
    update: PerformanceUpdate
  ): PerformancePersonnelle {
    
    const newEntry = {
      annee: update.annee,
      zoneCultivee: update.zone,
      poidsTotalKg: update.poidsTotalKg,
      qualiteMoyenne: update.qualiteMoyenne,
      problemes: update.problemes || [],
      succes: update.succes || []
    };

    const newHistorique = [...current.historique, newEntry];
    const totalKg = newHistorique.reduce((sum, entry) => sum + entry.poidsTotalKg, 0);
    const totalCultivations = newHistorique.length;
    const avgQuality = newHistorique.reduce((sum, entry) => sum + entry.qualiteMoyenne, 0) / totalCultivations;

    // D√©terminer meilleure r√©colte
    const bestHarvest = newHistorique.reduce((best, entry) => 
      entry.poidsTotalKg > best.poidsTotalKg ? entry : best
    );

    return {
      ...current,
      nombreCultivations: totalCultivations,
      tauxReussite: totalCultivations > 0 ? 
        newHistorique.filter(entry => entry.poidsTotalKg > 0).length / totalCultivations : 0,
      rendementMoyenKg: totalKg / totalCultivations,
      rendementMoyenKgM2: update.surfaceM2 ? totalKg / (totalCultivations * update.surfaceM2) : 0,
      meilleureRecolte: {
        annee: bestHarvest.annee,
        poids: bestHarvest.poidsTotalKg,
        notesQualite: bestHarvest.qualiteMoyenne
      },
      historique: newHistorique,
      derniereMiseAJour: new Date().toISOString(),
      calculPar: 'AUTO'
    };
  }
}

interface VarietySearchParams {
  userId?: string;
  query?: string;
  categories?: CategorieCulture[];
  difficultyMax?: number;
  currentMonth?: number;
  climate?: {
    typeSol: string;
    zone: string;
  };
  favoritesOnly?: boolean;
  includeAI?: boolean;
  includeRecommendations?: boolean;
  sortBy?: 'name' | 'difficulty' | 'popularity' | 'performance';
  limit?: number;
}

interface VarietySearchResult {
  varieties: (VarieteCulture & {
    varietesUtilisateur?: VarieteCultureUtilisateur[];
    _count: { varietesUtilisateur: number };
  })[];
  totalCount: number;
  filters: AvailableFilters;
  recommendations?: PersonalizedRecommendation[];
}
```

## **üì± Interface Mobile (Recherche rapide)**

### **Catalogue mobile avec recherche intelligente**
```typescript
const MobileVarietyCatalog = () => {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedFilters, setSelectedFilters] = useState<VarietyFilters>({});
  const [view, setView] = useState<'grid' | 'list'>('grid');
  
  const { data: varieties, isLoading } = useVarietySearch({
    query: searchQuery,
    ...selectedFilters,
    includeAI: true
  });

  const { data: recommendations } = usePersonalizedRecommendations();

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header avec recherche */}
      <div className="bg-white shadow-sm p-4 sticky top-0 z-10">
        <div className="flex items-center space-x-3">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5" />
            <Input
              placeholder="Rechercher une vari√©t√©..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10 h-12"
            />
          </div>
          
          <Button
            variant="outline" 
            size="sm"
            onClick={() => setView(view === 'grid' ? 'list' : 'grid')}
          >
            {view === 'grid' ? <List className="h-4 w-4" /> : <Grid className="h-4 w-4" />}
          </Button>
        </div>
        
        {/* Filtres rapides */}
        <QuickFilters 
          filters={selectedFilters}
          onChange={setSelectedFilters}
        />
      </div>

      {/* Recommandations IA si disponibles */}
      {recommendations?.length > 0 && (
        <div className="p-4">
          <h2 className="text-lg font-semibold mb-3 flex items-center">
            <Sparkles className="h-5 w-5 text-yellow-500 mr-2" />
            Recommand√©es pour vous
          </h2>
          
          <ScrollView horizontal className="space-x-3">
            {recommendations.slice(0, 5).map(rec => (
              <RecommendationCard 
                key={rec.variete.id}
                recommendation={rec}
                onSelect={() => handleVarietySelect(rec.variete)}
              />
            ))}
          </ScrollView>
        </div>
      )}

      {/* Liste/Grille des vari√©t√©s */}
      <div className="p-4">
        {isLoading ? (
          <VarietySkeletonList />
        ) : view === 'grid' ? (
          <VarietyGrid varieties={varieties} />
        ) : (
          <VarietyList varieties={varieties} />
        )}
      </div>

      {/* FAB pour ajouter vari√©t√© personnalis√©e */}
      <FloatingActionButton
        icon={<Plus className="h-6 w-6" />}
        onClick={() => navigation.navigate('AddCustomVariety')}
        className="fixed bottom-6 right-6"
      />
    </div>
  );
};

const QuickFilters = ({ filters, onChange }) => (
  <div className="flex space-x-2 mt-3 overflow-x-auto pb-2">
    <FilterChip
      label="Faciles"
      active={filters.difficultyMax === 2}
      onClick={() => onChange({ 
        ...filters, 
        difficultyMax: filters.difficultyMax === 2 ? undefined : 2 
      })}
      icon="üå±"
    />
    
    <FilterChip
      label="Saison actuelle"
      active={filters.currentSeason}
      onClick={() => onChange({ 
        ...filters, 
        currentSeason: !filters.currentSeason 
      })}
      icon="üìÖ"
    />
    
    <FilterChip
      label="Mes favoris"
      active={filters.favoritesOnly}
      onClick={() => onChange({ 
        ...filters, 
        favoritesOnly: !filters.favoritesOnly 
      })}
      icon="‚≠ê"
    />
    
    <FilterChip
      label="L√©gumes"
      active={filters.categories?.includes('LEGUME')}
      onClick={() => onChange({ 
        ...filters, 
        categories: toggleCategory(filters.categories, 'LEGUME')
      })}
      icon="ü•ï"
    />
    
    <FilterChip
      label="Aromates"
      active={filters.categories?.includes('HERBE_AROMATIQUE')}
      onClick={() => onChange({ 
        ...filters, 
        categories: toggleCategory(filters.categories, 'HERBE_AROMATIQUE')
      })}
      icon="üåø"
    />
  </div>
);

const VarietyGrid = ({ varieties }) => (
  <div className="grid grid-cols-2 gap-4">
    {varieties.map(variety => (
      <VarietyCard 
        key={variety.id}
        variety={variety}
        compact={true}
      />
    ))}
  </div>
);

const VarietyCard = ({ variety, compact = false }) => {
  const userVariety = variety.varietesUtilisateur?.[0];
  const performance = userVariety?.performancePersonnelle as PerformancePersonnelle;

  return (
    <motion.div
      whileTap={{ scale: 0.98 }}
      className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
    >
      {/* Image de la vari√©t√© */}
      <div className="aspect-square bg-gradient-to-br from-green-100 to-emerald-100 relative">
        {variety.photos?.[0] ? (
          <img 
            src={variety.photos[0].url}
            alt={variety.nomCommun}
            className="w-full h-full object-cover"
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center">
            <div className="text-4xl">
              {getCategoryIcon(variety.categorie)}
            </div>
          </div>
        )}
        
        {/* Badge difficult√© */}
        <div className="absolute top-2 right-2">
          <DifficultyBadge level={variety.infosCulture.niveauDifficulte} />
        </div>
        
        {/* Badge favori */}
        {userVariety?.estFavorite && (
          <div className="absolute top-2 left-2">
            <div className="bg-yellow-400 rounded-full p-1">
              <Star className="h-4 w-4 text-white fill-current" />
            </div>
          </div>
        )}
      </div>

      {/* Contenu */}
      <div className="p-3">
        <h3 className="font-medium text-gray-900 truncate">
          {userVariety?.nomPersonnalise || variety.nomCommun}
        </h3>
        
        <p className="text-sm text-gray-500 truncate">
          {variety.famille}
        </p>

        {/* Performance utilisateur si disponible */}
        {performance && (
          <div className="mt-2 flex items-center justify-between text-xs">
            <span className="text-green-600">
              ‚úì {performance.nombreCultivations} cultures
            </span>
            <span className="text-blue-600">
              {(performance.tauxReussite * 100).toFixed(0)}% r√©ussite
            </span>
          </div>
        )}

        {/* Infos rapides */}
        <div className="mt-2 flex items-center justify-between text-xs text-gray-500">
          <span>{variety.infosCulture.joursRecolte} jours</span>
          <span>{variety.infosCulture.besoinsEau} eau</span>
        </div>
      </div>
    </motion.div>
  );
};

const RecommendationCard = ({ recommendation, onSelect }) => (
  <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 min-w-[280px] border border-blue-200">
    <div className="flex items-start space-x-3">
      <div className="text-3xl">
        {getCategoryIcon(recommendation.variete.categorie)}
      </div>
      
      <div className="flex-1">
        <h3 className="font-medium text-gray-900">
          {recommendation.variete.nomCommun}
        </h3>
        
        <div className="flex items-center space-x-2 mt-1">
          <div className="flex items-center">
            <Sparkles className="h-3 w-3 text-yellow-500 mr-1" />
            <span className="text-sm font-medium text-blue-600">
              {(recommendation.scoreRecommandation * 100).toFixed(0)}% match
            </span>
          </div>
          
          <div className="text-sm text-gray-500">
            {(recommendation.probabiliteSucces * 100).toFixed(0)}% succ√®s
          </div>
        </div>
        
        <p className="text-xs text-gray-600 mt-2 leading-relaxed">
          {recommendation.raisons[0]}
        </p>
        
        <Button 
          size="sm" 
          className="mt-3 w-full"
          onClick={onSelect}
        >
          Voir d√©tails
        </Button>
      </div>
    </div>
  </div>
);
```

## **üíª Desktop (Gestion compl√®te des fiches)**

### **Interface compl√®te de gestion**
```typescript
const DesktopVarietyManagement = () => {
  const [selectedVariety, setSelectedVariety] = useState<VarieteCulture>();
  const [view, setView] = useState<'catalog' | 'personal' | 'create'>('catalog');
  const [searchFilters, setSearchFilters] = useState<AdvancedFilters>({});

  return (
    <div className="h-screen flex">
      {/* Sidebar navigation */}
      <div className="w-80 bg-gray-50 border-r overflow-y-auto">
        <div className="p-4">
          <h2 className="text-lg font-bold mb-4">üå± Gestion des vari√©t√©s</h2>
          
          <Tabs value={view} onValueChange={setView}>
            <TabsList className="grid w-full grid-cols-3">
              <TabsTrigger value="catalog">Catalogue</TabsTrigger>
              <TabsTrigger value="personal">Mes vari√©t√©s</TabsTrigger>
              <TabsTrigger value="create">Cr√©er</TabsTrigger>
            </TabsList>

            <TabsContent value="catalog" className="mt-4">
              <CatalogTab 
                filters={searchFilters}
                onFiltersChange={setSearchFilters}
                onVarietySelect={setSelectedVariety}
              />
            </TabsContent>

            <TabsContent value="personal" className="mt-4">
              <PersonalVarietiesTab 
                onVarietySelect={setSelectedVariety}
              />
            </TabsContent>

            <TabsContent value="create" className="mt-4">
              <CreateVarietyTab />
            </TabsContent>
          </Tabs>
        </div>
      </div>

      {/* Zone principale */}
      <div className="flex-1 flex flex-col">
        {selectedVariety ? (
          <VarietyDetailPanel 
            variety={selectedVariety}
            onClose={() => setSelectedVariety(undefined)}
          />
        ) : (
          <EmptyState />
        )}
      </div>
    </div>
  );
};

const CatalogTab = ({ filters, onFiltersChange, onVarietySelect }) => {
  const { data: varieties, isLoading } = useVarietySearch(filters);
  const { data: stats } = useCatalogStats();

  return (
    <div className="space-y-4">
      {/* Statistiques rapides */}
      <div className="grid grid-cols-2 gap-3">
        <div className="bg-white p-3 rounded border text-center">
          <div className="text-2xl font-bold text-green-600">{stats?.total}</div>
          <div className="text-xs text-gray-500">Vari√©t√©s totales</div>
        </div>
        <div className="bg-white p-3 rounded border text-center">
          <div className="text-2xl font-bold text-blue-600">{stats?.personal}</div>
          <div className="text-xs text-gray-500">Mes vari√©t√©s</div>
        </div>
      </div>

      {/* Filtres avanc√©s */}
      <AdvancedFilters 
        filters={filters}
        onChange={onFiltersChange}
      />

      {/* Liste des vari√©t√©s */}
      <div className="space-y-2">
        {isLoading ? (
          <SkeletonList count={10} />
        ) : (
          varieties?.map(variety => (
            <VarietyListItem
              key={variety.id}
              variety={variety}
              onClick={() => onVarietySelect(variety)}
            />
          ))
        )}
      </div>
    </div>
  );
};

const VarietyDetailPanel = ({ variety, onClose }) => {
  const [activeTab, setActiveTab] = useState('info');
  const { data: userVariety } = useUserVariety(variety.id);
  const { data: cultivationHistory } = useCultivationHistory(variety.id);

  return (
    <div className="flex-1 flex flex-col">
      {/* Header */}
      <div className="bg-white border-b p-6">
        <div className="flex items-start justify-between">
          <div className="flex items-start space-x-4">
            <div className="w-20 h-20 bg-gradient-to-br from-green-100 to-emerald-100 rounded-lg flex items-center justify-center">
              {variety.photos?.[0] ? (
                <img 
                  src={variety.photos[0].url}
                  className="w-full h-full object-cover rounded-lg"
                />
              ) : (
                <div className="text-3xl">
                  {getCategoryIcon(variety.categorie)}
                </div>
              )}
            </div>
            
            <div>
              <h1 className="text-2xl font-bold text-gray-900">
                {userVariety?.nomPersonnalise || variety.nomCommun}
              </h1>
              <p className="text-gray-600">{variety.nomScientifique}</p>
              <div className="flex items-center space-x-4 mt-2">
                <Badge variant="outline">{variety.famille}</Badge>
                <DifficultyBadge level={variety.infosCulture.niveauDifficulte} />
                {userVariety?.estFavorite && (
                  <Badge variant="secondary">
                    <Star className="h-3 w-3 mr-1 fill-current" />
                    Favori
                  </Badge>
                )}
              </div>
            </div>
          </div>
          
          <div className="flex items-center space-x-2">
            <PersonalizationButton variety={variety} />
            <Button variant="ghost" size="sm" onClick={onClose}>
              <X className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </div>

      {/* Navigation onglets */}
      <div className="bg-white border-b">
        <nav className="px-6">
          <div className="flex space-x-8">
            {[
              { id: 'info', label: 'Informations', icon: Info },
              { id: 'culture', label: 'Culture', icon: Sprout },
              { id: 'performance', label: 'Performance', icon: TrendingUp },
              { id: 'calendar', label: 'Calendrier', icon: Calendar },
              { id: 'companions', label: 'Associations', icon: Users }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2 ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <tab.icon className="h-4 w-4" />
                <span>{tab.label}</span>
              </button>
            ))}
          </div>
        </nav>
      </div>

      {/* Contenu des onglets */}
      <div className="flex-1 overflow-y-auto p-6">
        {activeTab === 'info' && (
          <VarietyInfoTab variety={variety} userVariety={userVariety} />
        )}
        {activeTab === 'culture' && (
          <CultureInfoTab variety={variety} />
        )}
        {activeTab === 'performance' && (
          <PerformanceTab 
            variety={variety} 
            userVariety={userVariety}
            history={cultivationHistory}
          />
        )}
        {activeTab === 'calendar' && (
          <CalendarTab variety={variety} />
        )}
        {activeTab === 'companions' && (
          <CompanionsTab variety={variety} />
        )}
      </div>
    </div>
  );
};

const PerformanceTab = ({ variety, userVariety, history }) => {
  const performance = userVariety?.performancePersonnelle as PerformancePersonnelle;

  if (!performance || performance.nombreCultivations === 0) {
    return (
      <div className="text-center py-12">
        <TrendingUp className="h-12 w-12 text-gray-400 mx-auto mb-4" />
        <h3 className="text-lg font-medium text-gray-900 mb-2">
          Aucune donn√©e de performance
        </h3>
        <p className="text-gray-500 mb-4">
          Cultivez cette vari√©t√© pour voir vos statistiques
        </p>
        <Button>
          Planifier une culture
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* M√©triques principales */}
      <div className="grid grid-cols-4 gap-4">
        <MetricCard
          title="Cultivations"
          value={performance.nombreCultivations}
          unit="fois"
          color="blue"
        />
        <MetricCard
          title="Taux de r√©ussite"
          value={`${(performance.tauxReussite * 100).toFixed(0)}%`}
          color={performance.tauxReussite > 0.8 ? 'green' : performance.tauxReussite > 0.5 ? 'yellow' : 'red'}
        />
        <MetricCard
          title="Rendement moyen"
          value={performance.rendementMoyenKg.toFixed(1)}
          unit="kg"
          color="green"
        />
        <MetricCard
          title="Meilleure r√©colte"
          value={performance.meilleureRecolte.poids.toFixed(1)}
          unit="kg"
          subtitle={`en ${performance.meilleureRecolte.annee}`}
          color="purple"
        />
      </div>

      {/* Graphique historique */}
      <Card>
        <CardHeader>
          <CardTitle>√âvolution des rendements</CardTitle>
        </CardHeader>
        <CardContent>
          <PerformanceChart data={performance.historique} />
        </CardContent>
      </Card>

      {/* Conditions optimales d√©couvertes */}
      {performance.conditionsOptimales && (
        <Card>
          <CardHeader>
            <CardTitle>Conditions optimales sur votre terrain</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-3 gap-4">
              <div>
                <h4 className="font-medium text-gray-900 mb-2">Zone pr√©f√©r√©e</h4>
                <p className="text-gray-600">{performance.conditionsOptimales.zone}</p>
              </div>
              <div>
                <h4 className="font-medium text-gray-900 mb-2">Exposition</h4>
                <p className="text-gray-600">{performance.conditionsOptimales.exposition}</p>
              </div>
              <div>
                <h4 className="font-medium text-gray-900 mb-2">Amendements efficaces</h4>
                <div className="space-y-1">
                  {performance.conditionsOptimales.amendements.map((amendement, index) => (
                    <Badge key={index} variant="outline" className="mr-1">
                      {amendement}
                    </Badge>
                  ))}
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Historique d√©taill√© */}
      <Card>
        <CardHeader>
          <CardTitle>Historique des cultures</CardTitle>
        </CardHeader>
        <CardContent>
          <CultivationHistoryTable data={performance.historique} />
        </CardContent>
      </Card>
    </div>
  );
};
```

## **üì∫ TV (Galerie visuelle des vari√©t√©s)**

### **Interface vitrine spectaculaire**
```typescript
const TVVarietyShowcase = () => {
  const { data: favorites } = useFavoriteVarieties();
  const { data: recommendations } = usePersonalizedRecommendations();
  const { data: seasonal } = useSeasonalVarieties();
  
  const [currentSection, setCurrentSection] = useState(0);
  
  const sections = [
    { title: "Mes Vari√©t√©s Favorites", data: favorites, icon: "‚≠ê" },
    { title: "Recommandations IA", data: recommendations, icon: "ü§ñ" },
    { title: "De Saison", data: seasonal, icon: "üìÖ" }
  ];

  useEffect(() => {
    // Rotation automatique des sections
    const interval = setInterval(() => {
      setCurrentSection(prev => (prev + 1) % sections.length);
    }, 10000);
    
    return () => clearInterval(interval);
  }, [sections.length]);

  const currentData = sections[currentSection];

  return (
    <div className="h-screen bg-gradient-to-br from-green-900 via-emerald-800 to-green-900 text-white">
      {/* Header avec titre anim√© */}
      <div className="p-8 text-center">
        <motion.h1 
          key={currentSection}
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-5xl font-bold mb-4 flex items-center justify-center"
        >
          <span className="text-6xl mr-4">{currentData.icon}</span>
          {currentData.title}
        </motion.h1>
        
        {/* Indicateur de section */}
        <div className="flex justify-center space-x-2 mt-4">
          {sections.map((_, index) => (
            <div
              key={index}
              className={`w-3 h-3 rounded-full transition-colors ${
                index === currentSection ? 'bg-white' : 'bg-white/30'
              }`}
            />
          ))}
        </div>
      </div>

      {/* Galerie principale */}
      <div className="px-12 py-8">
        <AnimatePresence mode="wait">
          <motion.div
            key={currentSection}
            initial={{ opacity: 0, x: 100 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: -100 }}
            transition={{ duration: 0.8 }}
            className="grid grid-cols-6 gap-6 h-96"
          >
            {currentData.data?.slice(0, 6).map((item, index) => (
              <TVVarietyCard 
                key={item.id || index}
                variety={item.variete || item}
                performance={item.performance}
                recommendation={item.scoreRecommandation}
                delay={index * 0.1}
              />
            ))}
          </motion.div>
        </AnimatePresence>
      </div>

      {/* Footer avec stats globales */}
      <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-30 backdrop-blur-sm p-6">
        <TVStatsFooter />
      </div>
    </div>
  );
};

const TVVarietyCard = ({ variety, performance, recommendation, delay }) => {
  const infosCulture = variety.infosCulture as InfosCulture;

  return (
    <motion.div
      initial={{ opacity: 0, y: 50 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay, duration: 0.6 }}
      className="group relative bg-white bg-opacity-10 backdrop-blur-sm rounded-xl overflow-hidden hover:bg-opacity-20 transition-all duration-300"
    >
      {/* Image de fond */}
      <div className="aspect-square bg-gradient-to-br from-green-100 to-emerald-100 relative overflow-hidden">
        {variety.photos?.[0] ? (
          <img 
            src={variety.photos[0].url}
            alt={variety.nomCommun}
            className="w-full h-full object-cover"
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center">
            <div className="text-6xl opacity-80">
              {getCategoryIcon(variety.categorie)}
            </div>
          </div>
        )}
        
        {/* Overlay graduel pour lisibilit√© */}
        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent" />
      </div>

      {/* Badges overlay */}
      <div className="absolute top-3 left-3 right-3 flex justify-between">
        <DifficultyBadge 
          level={infosCulture.niveauDifficulte} 
          size="large"
        />
        
        {recommendation && (
          <div className="bg-yellow-500 bg-opacity-90 rounded-full px-2 py-1 text-xs font-medium text-black">
            ü§ñ {(recommendation * 100).toFixed(0)}%
          </div>
        )}
      </div>

      {/* Contenu principal */}
      <div className="absolute bottom-0 left-0 right-0 p-4 text-white">
        <h3 className="font-bold text-lg mb-1 line-clamp-2">
          {variety.nomCommun}
        </h3>
        
        <p className="text-sm opacity-80 mb-2">
          {variety.famille}
        </p>

        {/* M√©triques performance ou infos */}
        <div className="flex items-center justify-between text-xs">
          {performance ? (
            <>
              <span className="bg-green-500 bg-opacity-20 px-2 py-1 rounded">
                ‚úì {performance.nombreCultivations} cultures
              </span>
              <span className="bg-blue-500 bg-opacity-20 px-2 py-1 rounded">
                {(performance.tauxReussite * 100).toFixed(0)}% r√©ussite
              </span>
            </>
          ) : (
            <>
              <span className="bg-white bg-opacity-20 px-2 py-1 rounded">
                {infosCulture.joursRecolte} jours
              </span>
              <span className="bg-white bg-opacity-20 px-2 py-1 rounded">
                {infosCulture.besoinsEau} eau
              </span>
            </>
          )}
        </div>
      </div>

      {/* Animation hover subtile */}
      <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <div className="absolute inset-0 bg-white bg-opacity-5" />
        <div className="absolute inset-0 ring-2 ring-white ring-opacity-30 rounded-xl" />
      </div>
    </motion.div>
  );
};

const TVStatsFooter = () => {
  const { data: stats } = useVarietyStats();

  return (
    <div className="flex justify-center space-x-16">
      <TVMetric
        icon="üå±"
        value={stats?.totalVarieties}
        label="vari√©t√©s au catalogue"
      />
      <TVMetric
        icon="‚≠ê"
        value={stats?.favoriteVarieties}
        label="vari√©t√©s favorites"
      />
      <TVMetric
        icon="üìä"
        value={`${stats?.avgSuccessRate}%`}
        label="taux de r√©ussite moyen"
      />
      <TVMetric
        icon="üèÜ"
        value={stats?.bestPerformer?.nomCommun}
        label="meilleure performance"
      />
    </div>
  );
};
```

## **‚úÖ Crit√®res d'acceptation**

### **Base de connaissances**
- [ ] **Catalogue pr√©-rempli** avec 100+ vari√©t√©s courantes ‚úÖ
- [ ] **Fiches techniques compl√®tes** (plantation, culture, r√©colte) ‚úÖ
- [ ] **Personnalisation utilisateur** avec notes et photos ‚úÖ
- [ ] **Tracking performance** automatique par terrain ‚úÖ

### **Recherche et filtrage**
- [ ] **Recherche textuelle** full-text PostgreSQL ‚úÖ
- [ ] **Filtres avanc√©s** (famille, difficult√©, saison, climat) ‚úÖ
- [ ] **Recommandations IA** personnalis√©es selon historique ‚úÖ
- [ ] **Tri intelligent** par popularit√©, performance, nom ‚úÖ

### **Interface par device**
- [ ] **Mobile** : Recherche rapide + recommandations contextuelles ‚úÖ
- [ ] **Desktop** : Gestion compl√®te avec onglets d√©taill√©s ‚úÖ
- [ ] **TV** : Galerie spectaculaire avec rotation automatique ‚úÖ

### **Performance & donn√©es**
- [ ] **Calculs automatiques** m√©triques performance ‚úÖ
- [ ] **Cache intelligent** Redis pour recherches fr√©quentes ‚úÖ
- [ ] **Export/import** donn√©es vari√©t√©s personnalis√©es ‚úÖ
- [ ] **Synchronisation** cross-device des favoris ‚úÖ

### **Extensions futures**
- [ ] **Integration scan F2.6** pour import automatique ‚úÖ
- [ ] **API recommendations** pour planning F2.2 ‚úÖ
- [ ] **Donn√©es IA** pour analyses pr√©dictives F5.x ‚úÖ

## **üèóÔ∏è Exigences architecturales couvertes**

- **EXG-001.2** : API Routes `/src/app/api/varieties/*` ‚úÖ
- **EXG-002.1** : PostgreSQL avec full-text search ‚úÖ
- **EXG-002.2** : Mod√®les Prisma extensibles et versionn√©s ‚úÖ
- **EXG-002.3** : Cache Redis pour performance recherche ‚úÖ
- **EXG-003.2** : Interface responsive üì±üíªüì∫ ‚úÖ
- **EXG-005.1** : IA recommendations optimis√©e co√ªts ‚úÖ
- **EXG-007.3** : Performance < 2s avec index optimis√©s ‚úÖ

## **üöÄ Plan d'impl√©mentation**

### **Phase 1 : Mod√®les & API (4j)**
1. Mod√®les Prisma VarieteCulture + VarieteCultureUtilisateur
2. Service de recherche avec filtres PostgreSQL
3. API Routes CRUD compl√®tes
4. Syst√®me de cache Redis intelligent

### **Phase 2 : Interface Mobile (3j)**
1. Catalogue avec recherche et filtres rapides
2. Cartes vari√©t√©s avec performance utilisateur
3. Recommandations IA contextuelles
4. Personnalisation et favoris

### **Phase 3 : Interface Desktop (4j)**
1. Gestionnaire complet avec onglets
2. Fiches d√©taill√©es avec historique performance
3. Cr√©ation/√©dition vari√©t√©s personnalis√©es
4. Import/export donn√©es

### **Phase 4 : Interface TV (2j)**
1. Galerie spectaculaire avec animations
2. Rotation automatique des sections
3. Stats globales en footer
4. Mode pr√©sentation immersif

### **Phase 5 : IA & Optimisation (2j)**
1. Service recommandations ML
2. Calculs automatiques performance
3. Optimisation queries et cache
4. Tests avec dataset r√©el

**Dur√©e totale estim√©e : 15 jours**