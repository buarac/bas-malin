# **F1.1 - Authentification & Gestion Multi-Utilisateurs**

## **üìã Informations g√©n√©rales**
- **Score de priorit√©** : 100/100 ‚≠ê CRITIQUE
- **EPIC** : FONDATIONS
- **Complexit√©** : √âlev√©e (s√©curit√© + multi-profils)
- **Devices** : üì±üíªüì∫

## **üéØ Description**
Syst√®me d'authentification s√©curis√© avec NextAuth.js supportant trois profils utilisateur distincts : Expert (acc√®s complet), Occasionnel (interface simplifi√©e), et Reader (consultation uniquement), avec synchronisation des sessions cross-device et permissions granulaires.

## **üë• User Stories**

### **Expert (Sacha)**
- En tant que Sacha, je veux un acc√®s complet √† toutes les fonctionnalit√©s pour g√©rer mon potager intelligent
- En tant qu'utilisateur expert, je veux pouvoir configurer les permissions des autres utilisateurs
- En tant qu'utilisateur expert, je veux acc√©der aux fonctionnalit√©s avanc√©es (IA, analytics, planification)

### **Occasionnel (√âpouse)**
- En tant qu'√©pouse, je veux une interface simplifi√©e pour saisir rapidement mes r√©coltes
- En tant qu'utilisateur occasionnel, je veux des √©crans guid√©s et √©pur√©s
- En tant qu'utilisateur occasionnel, je veux pouvoir consulter les synth√®ses sans complexit√©

### **Reader (Invit√©s, visiteurs)**
- En tant qu'utilisateur Reader, je veux pouvoir consulter les donn√©es du potager sans pouvoir les modifier
- En tant qu'invit√©, je veux voir les statistiques de r√©coltes et l'√©tat des cultures
- En tant qu'utilisateur Reader, je veux acc√©der aux dashboards et graphiques en lecture seule
- En tant qu'utilisateur Reader, je veux une interface √©pur√©e sans options d'√©dition

### **Multi-device**
- En tant qu'utilisateur, je veux que ma session soit synchronis√©e sur tous mes appareils (mobile, desktop, TV)
- En tant qu'utilisateur, je veux mes donn√©es s√©curis√©es en local sur mon NUC

## **üîß Sp√©cifications techniques**

### **Architecture NextAuth.js**
```typescript
// Configuration NextAuth avec Prisma Adapter
export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(prisma),
  providers: [
    CredentialsProvider({
      name: "credentials",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" }
      },
      async authorize(credentials) {
        // Authentification avec hash bcrypt
        // Retour User avec typeProfil
      }
    })
  ],
  session: { 
    strategy: "database",
    maxAge: 7 * 24 * 60 * 60 // 7 jours max
  },
  callbacks: {
    async session({ session, user }) {
      // Enrichir session avec typeProfil et permissions
      session.user.typeProfil = user.typeProfil;
      session.user.permissions = await getPermissions(user.id);
      return session;
    }
  },
  pages: {
    signIn: '/auth/signin',
    error: '/auth/error',
  }
}
```

### **Mod√®les de donn√©es (selon data_models_bas_malin.md)**
```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  
  // Extensions Ba≈°-Malin
  passwordHash  String
  typeProfil    TypeProfil @default(OCCASIONNEL)
  prenom        String?
  nom           String?
  locale        String     @default("fr-FR")
  preferences   Json?      // UI preferences par profil
  
  // Relations NextAuth + m√©tier
  accounts Account[]
  sessions Session[]
  jardins  Jardin[]
  permissions PermissionUtilisateur[]
}

enum TypeProfil {
  EXPERT        // Acc√®s complet
  OCCASIONNEL   // Interface simplifi√©e
  READER        // Lecture seule
}
```

### **Permissions par profil**
```typescript
// Permissions par d√©faut par profil
const DEFAULT_PERMISSIONS: Record<TypeProfil, Permission[]> = {
  EXPERT: [Permission.LECTURE, Permission.ECRITURE, Permission.SUPPRESSION, Permission.ADMIN],
  OCCASIONNEL: [Permission.LECTURE, Permission.ECRITURE],
  READER: [Permission.LECTURE]
};

// Pages autoris√©es par profil
const ALLOWED_PAGES: Record<TypeProfil, string[]> = {
  EXPERT: ['*'], // Toutes les pages
  OCCASIONNEL: [
    '/dashboard',
    '/recoltes',
    '/recoltes/nouvelle',
    '/jardins',
    '/profil'
  ],
  READER: [
    '/dashboard',
    '/recoltes',
    '/jardins',
    '/analytics',
    '/profil'
  ] // Pas d'acc√®s aux pages d'√©dition
};
```

### **Syst√®me de permissions granulaires**
```typescript
enum TypeRessource {
  JARDIN = "jardin",
  RECOLTE = "recolte", 
  INTERVENTION = "intervention",
  ANALYSE = "analyse",
  IOT = "iot",
  MCP = "mcp"
}

enum Permission {
  LECTURE = "read",
  ECRITURE = "write", 
  SUPPRESSION = "delete",
  ADMIN = "admin"
}

// Middleware de v√©rification permissions
export function requirePermission(resource: TypeRessource, permission: Permission) {
  return async (req: NextRequest) => {
    const session = await getServerSession(authOptions);
    const hasPermission = await checkPermission(
      session.user.id, 
      resource, 
      permission
    );
    if (!hasPermission) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }
  };
}
```

## **üé® Interface par device**

### **üì± Mobile**
```typescript
// Composant de connexion mobile
const MobileSignIn = () => (
  <form className="p-6 space-y-4">
    <Input 
      type="email"
      placeholder="Email"
      className="h-14 text-lg" // Touch-friendly
      autoComplete="username"
    />
    <Input 
      type="password"
      placeholder="Mot de passe"
      className="h-14 text-lg"
      autoComplete="current-password"
    />
    <Button className="w-full h-14 text-lg">
      Se connecter
    </Button>
  </form>
);

// Interface diff√©renci√©e par profil
const ProfileBasedNavigation = () => {
  const { data: session } = useSession();
  
  switch (session.user.typeProfil) {
    case 'READER':
      return <ReaderNavigation />; // 2-3 options lecture seule
    case 'OCCASIONNEL':
      return <SimpleNavigation />; // 3-4 options max
    case 'EXPERT':
    default:
      return <ExpertNavigation />; // Navigation compl√®te
  }
};
```

### **üíª Desktop**
```typescript
// Interface desktop riche
const DesktopDashboard = () => {
  const { data: session } = useSession();
  
  return (
    <div className="grid grid-cols-12 gap-6">
      <aside className="col-span-2">
        <UserProfile user={session.user} />
        <Navigation typeProfil={session.user.typeProfil} />
      </aside>
      
      <main className="col-span-10">
        {(() => {
          switch (session.user.typeProfil) {
            case 'EXPERT':
              return <ExpertDashboard />;
            case 'OCCASIONNEL':
              return <SimplifiedDashboard />;
            case 'READER':
              return <ReadOnlyDashboard />;
            default:
              return <ExpertDashboard />;
          }
        })()}
      </main>
    </div>
  );
};
```

### **üîç Interface READER (Lecture seule)**
```typescript
// Navigation √©pur√©e pour profil READER
const ReaderNavigation = () => (
  <nav className="space-y-2">
    <NavItem icon="üìä" label="Dashboard" href="/dashboard" />
    <NavItem icon="üçÖ" label="R√©coltes" href="/recoltes" />
    <NavItem icon="üå±" label="Jardins" href="/jardins" />
    <NavItem icon="üìà" label="Statistiques" href="/analytics" />
  </nav>
);

// Dashboard lecture seule
const ReadOnlyDashboard = () => (
  <div className="space-y-6">
    <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg">
      <p className="text-blue-800 flex items-center gap-2">
        <Eye className="w-4 h-4" />
        Mode consultation - Donn√©es en lecture seule
      </p>
    </div>
    
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <StatCard title="R√©coltes totales" value="45.2 kg" readonly />
      <StatCard title="Cultures actives" value="12" readonly />
      <StatCard title="Derni√®re r√©colte" value="Il y a 2 jours" readonly />
    </div>
    
    <ChartsSection readonly />
    <RecentHarvestsList readonly />
  </div>
);

// Composant de protection d'action
const ProtectedAction = ({ 
  children, 
  requiredPermission = Permission.ECRITURE 
}: {
  children: React.ReactNode;
  requiredPermission?: Permission;
}) => {
  const { data: session } = useSession();
  const userPermissions = DEFAULT_PERMISSIONS[session?.user.typeProfil || 'READER'];
  
  if (!userPermissions.includes(requiredPermission)) {
    return (
      <div className="opacity-50 pointer-events-none">
        {children}
      </div>
    );
  }
  
  return <>{children}</>;
};
```

### **üì∫ TV**
```typescript
// Interface TV avec navigation t√©l√©commande
const TVInterface = () => (
  <div className="h-screen bg-gradient-to-br from-green-900 to-emerald-800">
    <nav className="flex justify-center space-x-12 py-8">
      {/* Navigation simplifi√©e 4-5 options max */}
      <TVButton icon="üå±" label="Mon Potager" />
      <TVButton icon="üìä" label="R√©coltes" />
      <TVButton icon="üìÖ" label="Planning" />
      <TVButton icon="‚öôÔ∏è" label="Profil" />
    </nav>
    
    <main className="px-12 py-8">
      {/* Interface vitrine spectaculaire */}
    </main>
  </div>
);
```

## **üîÑ Flux d'authentification**

### **Processus de connexion**
1. **Saisie credentials** ‚Üí Validation format
2. **Hash verification** ‚Üí bcrypt.compare()
3. **Session cr√©ation** ‚Üí NextAuth.js + Prisma
4. **Enrichissement session** ‚Üí typeProfil + permissions
5. **Redirection adapt√©e** ‚Üí selon profil utilisateur

### **Synchronisation cross-device**
```typescript
// WebSocket pour sync sessions temps r√©el
const useSessionSync = () => {
  useEffect(() => {
    const ws = new WebSocket('/api/ws/session-sync');
    
    ws.onmessage = (event) => {
      const { type, data } = JSON.parse(event.data);
      
      if (type === 'SESSION_UPDATE') {
        // Synchroniser √©tat session entre devices
        mutate('/api/auth/session');
      }
    };
    
    return () => ws.close();
  }, []);
};
```

## **üîí S√©curit√©**

### **Chiffrement des mots de passe**
```typescript
import bcrypt from 'bcryptjs';

export async function hashPassword(password: string): Promise<string> {
  const saltRounds = 12; // S√©curit√© √©lev√©e
  return bcrypt.hash(password, saltRounds);
}

export async function verifyPassword(
  password: string, 
  hash: string
): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

### **Protection CSRF & Rate Limiting**
```typescript
// Middleware de protection API
export const protectedRoute = async (req: NextRequest) => {
  // 1. V√©rification session NextAuth
  const session = await getServerSession(authOptions);
  if (!session) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  // 2. Rate limiting : 100 req/min par utilisateur
  const rateLimitResult = await rateLimiter.check(session.user.id);
  if (!rateLimitResult.success) {
    return NextResponse.json({ error: "Rate limit exceeded" }, { status: 429 });
  }
  
  // 3. Log d'audit
  await logActivity({
    userId: session.user.id,
    action: req.method + ' ' + req.url,
    timestamp: new Date()
  });
};
```

## **‚úÖ Crit√®res d'acceptation**

### **Fonctionnels**
- [ ] Login s√©curis√© fonctionnel sur les 3 devices (üì±üíªüì∫)
- [ ] Profils Expert/Occasionnel/Reader avec interfaces diff√©renci√©es
- [ ] Permissions granulaires par ressource (JARDIN, RECOLTE, etc.)
- [ ] Sessions synchronis√©es cross-device < 3 secondes
- [ ] Mode offline mobile avec reconnexion automatique

### **Techniques**
- [ ] NextAuth.js + Prisma Adapter configur√©
- [ ] Hachage mots de passe bcrypt (12 rounds)
- [ ] Rate limiting 100 req/min par utilisateur
- [ ] Logs d'audit pour actions critiques
- [ ] Sessions expiration 7 jours maximum

### **UI/UX**
- [ ] Interface mobile touch-friendly (boutons 14px min)
- [ ] Interface TV navigation t√©l√©commande
- [ ] Profil Reader : 2-3 options navigation lecture seule
- [ ] Profil Occasionnel : 3-4 options navigation max
- [ ] Profil Expert : navigation compl√®te accessible
- [ ] Loading states et feedback utilisateur

### **Performance**
- [ ] Connexion/d√©connexion < 2 secondes
- [ ] Sync cross-device < 3 secondes
- [ ] Score Lighthouse authentification > 90%

## **üèóÔ∏è Exigences architecturales couvertes**

- **EXG-001.1** : Framework Next.js 14 App Router ‚úÖ
- **EXG-001.2** : API Routes dans `/src/app/api/auth/*` ‚úÖ
- **EXG-002.2** : Prisma + Prisma Adapter NextAuth.js ‚úÖ
- **EXG-002.3** : Redis pour cache applicatif (NextAuth g√©r√©) ‚úÖ
- **EXG-003.3** : Synchronisation temps r√©el < 3s ‚úÖ
- **EXG-007.3** : Temps de r√©ponse < 2s ‚úÖ
- **EXG-008.1** : NextAuth.js multi-profils (Expert/Occasionnel/Reader) ‚úÖ
- **EXG-008.2** : Chiffrement AES-256 variables environnement ‚úÖ
- **EXG-008.3** : Protection API + rate limiting 100 req/min ‚úÖ

## **üöÄ Plan d'impl√©mentation**

### **Phase 1 : Configuration NextAuth (2j)**
1. Installation NextAuth.js + Prisma Adapter
2. Configuration providers + callbacks
3. Setup base donn√©es User/Account/Session

### **Phase 2 : Profils utilisateur (3j)**
1. Extension mod√®les Prisma (TypeProfil, Permissions)
2. Middleware permissions granulaires
3. Interfaces diff√©renci√©es Expert/Occasionnel/Reader

### **Phase 3 : Multi-device (2j)**
1. WebSocket synchronisation sessions
2. Interface mobile responsive
3. Interface TV t√©l√©commande

### **Phase 4 : S√©curit√© & polish (2j)**
1. Rate limiting + logs d'audit
2. Tests s√©curit√© + load testing
3. Documentation compl√®te

**Dur√©e totale estim√©e : 9 jours**