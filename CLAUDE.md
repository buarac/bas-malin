# üå± **CLAUDE.md - Contexte Projet Ba≈°-Malin**

## **üìã Vue d'ensemble du projet**

**Ba≈°-Malin** est un √©cosyst√®me applicatif complet de gestion de potager intelligent, con√ßu pour transformer l'exp√©rience du jardinage amateur passionn√© en un syst√®me d'aide √† la d√©cision bas√© sur les donn√©es et l'IA.

### **üéØ Objectif principal**
Cr√©er des sp√©cifications techniques d√©taill√©es et impl√©menter toutes les 28 features du product backlog, permettant de g√©rer un potager intelligent avec IA native, multi-device et h√©bergement local.

### **üë• Personas principaux**
- **Sacha** : Jardinier expert avec grand jardin 1300m¬≤ (4 bacs de 8m x 0.8m) - Profil EXPERT
- **√âpouse (Marie)** : Contributrice occasionnelle, interface simplifi√©e - Profil OCCASIONNEL  
- **Invit√©s** : Consultation uniquement - Profil READER

### **üì± Architecture multi-device**
- **Mobile PWA** : Compagnon de terrain, usage offline
- **Desktop Web** : Centre de commandement, analyses
- **TV App** : √âcran vitrine, d√©monstrations

## **üèóÔ∏è Stack technique d√©finie**

### **Core Technologies**
- **Next.js 15** avec App Router (`/src/app/`)
- **TypeScript** strict configuration
- **PostgreSQL 16+** base unique avec PostGIS (192.168.1.30:5432)
- **Prisma ORM** avec Prisma Adapter NextAuth.js
- **Redis** pour cache applicatif
- **PM2** clustering 4 cores

### **Authentification & Users - ‚úÖ IMPL√âMENT√âE (F1.1)**
- **NextAuth.js 5** avec 3 profils : Expert / Occasionnel / Reader
- **Prisma Adapter** pour sessions base de donn√©es
- **bcrypt** hash mots de passe (12 rounds)
- **Permissions granulaires** par ressource
- **Rate limiting** 100 req/min par utilisateur

### **Intelligence Artificielle**
- **OpenAI GPT-4 Vision** pour reconnaissance r√©coltes (95% pr√©cision)
- **Anthropic Claude Pro** (abonnements existants)
- **BullMQ** pour traitement asynchrone
- **Ollama + Llama 3.1** fallback local
- **Budget IA** : 20-30‚Ç¨/mois maximum

### **IoT & Int√©grations**
- **Home Assistant** hub IoT sur m√™me NUC localhost:8123
- **ESP32** capteurs temp√©rature/humidit√© (futur)
- **WeatherAPI** pr√©visions 10 jours g√©olocalis√©es
- **MCP Server** exposition donn√©es pour IA externes

### **Infrastructure**
- **NUC Ubuntu** h√©bergement local (Intel i3-10110U, 8GB RAM)
- **Limite m√©moire** : 6GB max (75% des 8GB)
- **Performances** : < 2s chargement pages, < 3s sync multi-device

## **üìÇ Documents de r√©f√©rence**

### **1. vision_produit.md**
- Vision compl√®te avec 3 piliers : PRODUIRE ‚Üí COMPRENDRE ‚Üí OPTIMISER
- 9 axes fonctionnels d√©taill√©s par device (üì±üíªüì∫)
- Fonctionnalit√©s transverses : IA, m√©t√©o, multi-langue FR/SR

### **2. product_backlog_bas_malin.md**
- **28 features** r√©parties sur **7 EPICs**
- Scoring de priorit√© d√©taill√© (100 ‚Üí 30/100)
- Features critiques identifi√©es (F1.1, F2.5, F1.2, F2.2, F4.1)

### **3. architecture_generale.md**
- **60 exigences architecturales** (EXG-001 √† EXG-010)
- Architecture Next.js + PostgreSQL + Redis d√©taill√©e
- Contraintes performance, s√©curit√©, d√©ploiement

### **4. data_models_bas_malin.md**
- **Mod√®les Prisma v2.0** complets avec NextAuth.js
- Tous domaines m√©tier : Auth, Jardin, Cultures, R√©coltes, IA, IoT, MCP
- Index et optimisations PostgreSQL

### **5. docs/features/**
- **Sp√©cifications d√©taill√©es** de chaque feature
- **F1.1** - Authentification & Multi-Utilisateurs ‚úÖ IMPL√âMENT√âE
- Format standardis√© avec code TypeScript, API Routes, crit√®res d'acceptation

## **‚úÖ Travail accompli**

### **üéØ Feature F1.1 - Authentification & Multi-Utilisateurs (100/100) - TERMIN√âE**

**Date d'impl√©mentation :** 21 ao√ªt 2025  
**Statut :** ‚úÖ Compl√®tement op√©rationnelle

#### **R√©alisations techniques :**
1. **Extension sch√©ma Prisma** avec profils EXPERT/OCCASIONNEL/READER
2. **NextAuth.js 5** configur√© avec CredentialsProvider + OAuth (GitHub/Google)
3. **Syst√®me de permissions granulaires** par ressource
4. **Interfaces diff√©renci√©es** par profil utilisateur
5. **S√©curit√© renforc√©e** : bcrypt, rate limiting, audit logs
6. **Composants UI** : navigation adapt√©e, protection des actions

#### **Comptes de test cr√©√©s :**
```bash
# Expert - Acc√®s complet (üëë)
sacha@basmalin.local / expert123

# Occasionnel - Interface simplifi√©e (üîß)  
marie@basmalin.local / occasionnel123

# Reader - Lecture seule (üëÅÔ∏è)
invite@basmalin.local / reader123
```

#### **Composants d√©velopp√©s :**
- `/src/components/auth/` : sign-in-form, user-menu, protected-action
- `/src/components/navigation/` : expert-navigation, occasionnel-navigation, reader-navigation
- `/src/components/dashboard/` : read-only-dashboard
- `/src/lib/security.ts` : hashPassword, permissions, audit
- `/src/lib/middleware.ts` : protection routes, rate limiting

## **üìã Travail restant - Features √† impl√©menter**

### **üî• PRIORIT√â √âLEV√âE (80-89/100) - 6 features**
- F2.1 - Gestion des Cultures & Vari√©t√©s (90/100)
- F2.4 - Suivi des Interventions & Journal de Bord (88/100)  
- F2.3 - Gestionnaire de Zones & Parcelles (85/100)
- F3.1 - Collecte & Consolidation Automatique (85/100)
- F4.2 - Syst√®me d'Alertes & Notifications (85/100)
- F1.4 - Design System & Composants UI (85/100)

### **üìà PRIORIT√â MOYENNE (60-79/100) - 9 features**
- F3.2 - M√©triques & Tableaux de Bord (88/100)
- F1.5 - Architecture API & Int√©grations (80/100)
- F3.3 - Historiques & Comparaisons Inter-annuelles (75/100)
- F5.1 - Moteur de Recommandations ML (70/100)
- F2.6 - Import/Scan de Graines & Emballages (70/100)
- F3.4 - Export/Import & Sauvegarde (70/100)
- F4.3 - Corr√©lations M√©t√©o-Culture Basiques (65/100)
- F6.1 - Planification Avanc√©e & Optimisation Rotations (60/100)

### **üîÆ PRIORIT√â FUTURE (< 60/100) - 6 features**
- F5.2 - Analyses Pr√©dictives & Pattern Mining (55/100)
- F5.3 - IA Conversationnelle & MCP Server (50/100)
- F7.1 - Interface TV Optimis√©e & Vitrine (50/100)
- F5.4 - Computer Vision Avanc√©e (45/100)
- F7.2 - Multi-langue FR/SR + Extensibilit√© (45/100)
- F6.2 - Pr√©paration Architecture IoT (40/100)
- F7.3 - PWA & Fonctionnalit√©s Offline Avanc√©es (35/100)

## **üéØ Patterns et conventions √©tablis**

### **Structure de sp√©cification standard**
```markdown
# **FX.X - Nom Feature**
## üìã Informations g√©n√©rales
## üéØ Description  
## üë• User Stories
## üîß Sp√©cifications techniques
## üì±üíªüì∫ Interface par device
## üîÑ API Routes
## ‚úÖ Crit√®res d'acceptation
## üèóÔ∏è Exigences architecturales couvertes
## üöÄ Plan d'impl√©mentation
```

### **Code patterns utilis√©s**
- **TypeScript interfaces** pour typage strict
- **Prisma models** selon data_models_bas_malin.md
- **NextAuth.js** int√©gration syst√©matique avec profils
- **React components** avec Tailwind CSS + shadcn/ui
- **API Routes** avec validation et error handling
- **Redis cache** avec TTL intelligents
- **Composants prot√©g√©s** selon permissions utilisateur

### **Conventions de nommage**
- **Fichiers** : kebab-case (user-menu.tsx, read-only-dashboard.tsx)
- **Composants** : PascalCase (UserMenu, ReadOnlyDashboard)
- **Fonctions** : camelCase (hashPassword, canAccessPage)
- **Constants** : UPPER_CASE (DEFAULT_PERMISSIONS, ALLOWED_PAGES)

## **üöÄ Prochaines √©tapes**

### **Objectif imm√©diat**
Continuer l'impl√©mentation des **22 features restantes** en suivant l'ordre de priorit√© √©tabli.

### **Ordre de traitement sugg√©r√©**
1. **F2.1** - Gestion des Cultures & Vari√©t√©s (base de donn√©es cultures)
2. **F2.4** - Suivi des Interventions & Journal de Bord (UX occasionnel)
3. **F2.3** - Gestionnaire de Zones & Parcelles (4 bacs + zones libres)
4. **F3.1** - Collecte & Consolidation Automatique (analytics)

### **Crit√®res de qualit√© √† maintenir**
- **Niveau de d√©tail** : Permettre impl√©mentation directe
- **Coh√©rence technique** : Respecter stack et patterns √©tablis
- **Mapping architectural** : Couvrir exigences EXG-xxx
- **Multi-device** : Interface adapt√©e üì±üíªüì∫
- **Performance** : Objectifs < 2s chargement
- **Permissions** : Respecter profils EXPERT/OCCASIONNEL/READER

---

## **üîß COMMANDES PR√â-AUTORIS√âES**

### **‚úÖ Toujours autoris√©es (ex√©cution directe, sans demander)**

#### **V√©rifications et diagnostics**
```bash
git status
git log --oneline -10
git diff
git diff HEAD~1
pm2 list
pm2 show [app-name]
pm2 logs [app-name]
```

#### **Linting et v√©rifications qualit√©**
```bash
npm run lint
npm run build
npx prisma generate
npx prisma db push
npx prisma studio  # Interface admin base de donn√©es
```

#### **Scripts de base de donn√©es (lecture seule et s√©curis√©s)**
```bash
./scripts/create-database.sh --help
./scripts/create-database.sh --check [projet] [env] [ip]
npm run create-test-users  # Utilisateurs F1.1 d√©j√† cr√©√©s
```

#### **Lecture de fichiers et exploration**
```bash
# Outils de lecture (utilise les tools Read, LS, Grep au lieu de bash)
ls, cat, grep, find # -> Utiliser LS, Read, Grep tools √† la place
tree -I node_modules
du -sh [directory]
```

#### **Tests et d√©veloppement**
```bash
npm install [package]
npm ci
npm run dev  # D√©marrage d√©veloppement
npm start    # D√©marrage production
npm test     # Si tests configur√©s
```

#### **Base de donn√©es - Op√©rations de lecture**
```bash
psql postgresql://user:pass@192.168.1.30:5432/bas-malin-dev -c "SELECT COUNT(*) FROM users;"
psql postgresql://user:pass@192.168.1.30:5432/bas-malin-dev -c "SELECT email, type_profil FROM users;"
# Toute requ√™te SELECT en lecture seule
```

### **‚ö†Ô∏è Demander confirmation avant (op√©rations sensibles)**

#### **Modifications critiques Git**
```bash
git add .
git commit -m "message"
git push
git reset --hard
git rebase
```

#### **Gestion PM2 et services**
```bash
pm2 stop [app-name]
pm2 restart [app-name] 
pm2 delete [app-name]
pm2 reload [app-name]
sudo systemctl restart [service]
```

#### **Scripts de base de donn√©es (modifications)**
```bash
./scripts/create-database.sh --force [projet] [env] [ip]
./scripts/create-database.sh --delete [projet] [env] [ip]
npx prisma migrate dev
npx prisma migrate deploy
npx prisma db seed
```

#### **Modifications de fichiers critiques**
```bash
# √âdition de fichiers de configuration sensibles
.env, .env.local, .env.production
package.json (dependencies)
tsconfig.json, next.config.ts
prisma/schema.prisma (schema changes)
docker-compose.yml
```

#### **Op√©rations de base de donn√©es (√©criture)**
```bash
# Toute requ√™te INSERT, UPDATE, DELETE, DROP, ALTER, CREATE
psql [...] -c "INSERT INTO ..."
psql [...] -c "UPDATE users SET ..."
psql [...] -c "DELETE FROM ..."
```

### **‚ùå Jamais autoriser automatiquement**

#### **Commandes syst√®me dangereuses**
```bash
rm -rf [anything]
sudo rm [anything] 
sudo chmod +x [scripts non valid√©s]
sudo chown [anything]
kill -9 [process]
shutdown, reboot
```

#### **Op√©rations Git destructives**
```bash
git reset --hard HEAD~[n]
git push --force
git branch -D [branch]
git clean -fd
```

#### **Modifications infrastructure**
```bash
# Changements configuration serveur
sudo nano /etc/[anything]
sudo systemctl disable [service]
docker-compose down
# Modifications r√©seau, firewall, etc.
```

## **üí° Instructions sp√©ciales**

### **Pour les nouvelles features**
1. **Toujours** lire la sp√©cification dans `docs/features/FX.X.md`
2. **Respecter** les 3 profils utilisateur (EXPERT/OCCASIONNEL/READER)
3. **Utiliser** les composants de protection existants (ProtectedAction, ProtectedButton)
4. **Suivre** les patterns √©tablis dans F1.1

### **Pour les probl√®mes**
1. **V√©rifier** les logs avec `pm2 logs bas-malin`
2. **Consulter** l'√©tat de la base avec `npx prisma studio`
3. **Tester** l'authentification avec les 3 comptes de test

### **Pour les commits**
- **Pr√©fixe** par feature : `feat(F2.1): ...` ou `fix(F1.1): ...`
- **Message** descriptif avec contexte m√©tier
- **Inclure** : `ü§ñ Generated with Claude Code`

## **üìä √âtat du projet**

### **‚úÖ Fonctionnel et test√©**
- ‚úÖ Authentification 3 profils (Expert/Occasionnel/Reader)
- ‚úÖ Base de donn√©es PostgreSQL + Prisma migrations
- ‚úÖ Interface multi-profils avec navigation adapt√©e
- ‚úÖ S√©curit√© : bcrypt, rate limiting, audit logs
- ‚úÖ Build et d√©ploiement fonctionnels

### **üîß En cours de d√©veloppement**
- Base de donn√©es des cultures et vari√©t√©s (F2.1)
- Interface de saisie des r√©coltes (F2.5)
- Gestionnaire de zones du potager (F2.3)

### **üì± Pr√™t pour**
- D√©marrage de nouvelles features prioritaires
- Tests utilisateur avec les 3 profils
- D√©ploiement sur environnement de staging

---

**üìÖ Derni√®re mise √† jour** : 21 ao√ªt 2025  
**üë®‚Äçüíª D√©veloppeur** : Sacha + Claude  
**üéØ Objectif** : Lancement Saison 2026 (Janvier 2026)  
**üå± Statut** : Feature F1.1 termin√©e, 22 features restantes

**üîë Authentification op√©rationnelle :** 3 profils utilisateur, s√©curit√© renforc√©e, interfaces diff√©renci√©es ‚úÖ